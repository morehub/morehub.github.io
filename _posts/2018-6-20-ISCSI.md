---
layout: post
title: ISCSI
---

[ISCSI](https://www.webopedia.com/TERM/I/iSCSI.html) (Abreviatura de Internet SCSI) es un estándar que permite el uso del
protocolo SCSI sobre redes TCP/IP. iSCSI es un protocolo de la capa de transporte definido en las especificaciones SCSI-3. 
Otros protocolos en la capa de transporte son SCSI Parallel Interface y canal de fibra. 

# CONFIGURACIÓN

SABER SOBRE MIS PARTICIONES

    fdisk -l

# CREAR PARTICION 

```
fdisk /dev/vdb 
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table
Building a new DOS disklabel with disk identifier 0x0cd07c31.

Orden (m para obtener ayuda): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): 
Using default response p
Número de partición (1-4, default 1): 
Primer sector (2048-4194303, valor predeterminado 2048): 
Se está utilizando el valor predeterminado 2048
Last sector, +sectors or +size{K,M,G} (2048-4194303, valor predeterminado 4194303): +500M
Partition 1 of type Linux and of size 500 MiB is set

Orden (m para obtener ayuda): p

Disk /dev/vdb: 2147 MB, 2147483648 bytes, 4194304 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Identificador del disco: 0x0cd07c31

Disposit. Inicio    Comienzo      Fin      Bloques  Id  Sistema
/dev/vdb1            2048     1026047      512000   83  Linux

Orden (m para obtener ayuda): w
¡Se ha modificado la tabla de particiones!

Llamando a ioctl() para volver a leer la tabla de particiones.
Se están sincronizando los discos.
```
CREACION DE VOLUMEN 

    partprobe -s
 
CREANDO VOLUMEN DE GRUPO
 
    vgcreate vg1 /dev/vdb1
 
CREANDO VOLUMEN LOGICO QUE UTILIZE TODO EL ESPACIO
 
    lvcreate -n lv01 vg1 -l 100%FREE
    
VERIFICANDO EL VOLUMEN CREADO
 
 ```
 lvs
 
  LV   VG      Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root rhel_x1 -wi-ao----   5,29g                                                    
  swap rhel_x1 -wi-ao---- 716,00m                                                    
  lv01 vg1     -wi-a----- 496,00m 
  ```

## INSTALANDO TARGET EN SERVIDOR HOST

    yum install targetcli

INICIAR TARGET 

    targetcli

## CREANDO BLOCKDEVICE 
 ```
/> backstores/block create datos /dev/vg1/lv01 
Created block storage object datos using /dev/vg1/lv01. 
 ```

## CREAR IQN 
 ```
/> iscsi/ create iqn.2017-08.com.example:server1
Created target iqn.2017-08.com.example:server1.
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.
 ```

## CREAR ACL PARA HABILITAR QUIEN PUEDE LEER ESTE BLOCKDEVICE
 ```
/> iscsi/iqn.2017-08.com.example:server1/tpg1/acls create iqn.2017-08.com.example.server2
Created Node ACL for iqn.2017-08.com.example.server2
 ```
## CREANDO LUNS
 ```
/> iscsi/iqn.2017-08.com.example:server1/tpg1/luns create /backstores/block/datos 
Created LUN 0.
Created LUN 0->0 mapping in node ACL iqn.2017-08.com.example.server2
 ```
## ASIGNANDO NETWORK PORTALS (IP DEL SERVIDOR HOST)
 ```
/> iscsi/iqn.2017-08.com.example:server1/tpg1/portals/ delete 0.0.0.0 3260
Deleted network portal 0.0.0.0:3260

/> iscsi/iqn.2017-08.com.example:server1/tpg1/portals/ create 192.168.122.16 3260
Using default IP port 3260
Created network portal 192.168.122.16:3260.
 ```
## VERIFICANDO CONFIGURACION

 CON CAT 
 ```
cat /etc/target/saveconfig.json
 ```
 CON TARGET
 ```
targetcli ls

o- / ..................................................................................................... [...]
  o- backstores .......................................................................................... [...]
  | o- block .............................................................................. [Storage Objects: 1]
  | | o- datos ................................................. [/dev/vg1/lv01 (496.0MiB) write-thru activated]
  | o- fileio ............................................................................. [Storage Objects: 0]
  | o- pscsi .............................................................................. [Storage Objects: 0]
  | o- ramdisk ............................................................................ [Storage Objects: 0]
  o- iscsi ........................................................................................ [Targets: 1]
  | o- iqn.2017-08.com.example:server1 ............................................................... [TPGs: 1]
  |   o- tpg1 ........................................................................... [no-gen-acls, no-auth]
  |     o- acls ...................................................................................... [ACLs: 1]
  |     | o- iqn.2017-08.com.example.server2 .................................................. [Mapped LUNs: 1]
  |     |   o- mapped_lun0 ............................................................. [lun0 block/datos (rw)]
  |     o- luns ...................................................................................... [LUNs: 1]
  |     | o- lun0 ................................................................ [block/datos (/dev/vg1/lv01)]
  |     o- portals ................................................................................ [Portals: 1]
  |       o- 192.168.122.16:3260 .......................................................................... [OK]
  o- loopback ..................................................................................... [Targets: 0]
 
 ```
## HABILITANDO FIREWALL

 ```
firewall-cmd --permanent --add-port=3260/tcp
success
firewall-cmd --reload
success
firewall-cmd --list-all

public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources: 
  services: dhcpv6-client
  ports: 3260/tcp
  protocols: 
  masquerade: no
  forward-ports: 
  sourceports: 
  icmp-blocks: 
  rich rules: 
 ```
 
 ## INICIANDO SERVICIOS 
 
  ```
systemctl enable target
Created symlink from /etc/systemd/system/multi-user.target.wants/target.service to /usr/lib/systemd/system/target.service.

systemctl start target

systemctl status target

● target.service - Restore LIO kernel target configuration
   Loaded: loaded (/usr/lib/systemd/system/target.service; enabled; vendor preset: disabled)
   Active: active (exited) since mar 2018-08-28 20:13:29 CLST; 8s ago
  Process: 5509 ExecStart=/usr/bin/targetctl restore (code=exited, status=0/SUCCESS)
 Main PID: 5509 (code=exited, status=0/SUCCESS)

ago 28 20:13:29 x1.example.com systemd[1]: Starting Restore LIO kernel target configuration...
ago 28 20:13:29 x1.example.com systemd[1]: Started Restore LIO kernel target configuration.

```
## CONFIGURANDO EN CLIENTE

 INSTALANDO CLIENTE 

    yum install iscsi-initiator-utils


COPIAMOS LA IQN DE LA ACL DEL HOST

    vim /etc/iscsi/initiatorname.iscsi 

    InitiatorName=iqn.2017-08.com.example.server2

REINICIAMOS EL SERVICIO 

```
systemctl enable iscsi
systemctl restart iscsi
systemctl status iscsi

```
DESCUBRIR TARGET

> saber sobre ejemplos de target en apartado examples
  
    man iscsiadm
    
 DESCUBRIENDO TARGET 

    iscsiadm --mode discoverydb --type sendtargets --portal 192.168.122.16 --discover

    192.168.122.16:3260,1 iqn.2017-08.com.example:server1

HACER LOGIN

```
iscsiadm --mode node --targetname iqn.2017-08.com.example:server1 --portal 192.168.122.16:3260 --login
Logging in to [iface: default, target: iqn.2017-08.com.example:server1, portal: 192.168.122.16,3260] (multiple)
Login to [iface: default, target: iqn.2017-08.com.example:server1, portal: 192.168.122.16,3260] successful.

```
VERIFICAR ISCSI

```
iscsiadm -m session -P3 | grep -i attach
lsscsi

```

CREANDO DIRECTORIO

```
mkdir /iscsi-datos
mkfs.xfs /dev/sda

```

MOSTRANDO UID

```
blkid | grep sda
echo "UUID="69d79151-9b6a-452b-801c-c243070b29ec" /iscsi-datos xfs _netdev 0 0" >> /etc/fstab

```
 MONTANDO 

    mount -a

VERIFICANDO 

```
df -h | grep iscsi

/dev/sda                   493M    25M  468M   6% /iscsi-datos

```

 DESMONTANDO Y DESLOGUEANDO

```
umount /iscsi-datos/
iscsiadm --mode node --targetname iqn.2017-08.com.example:server1 --portal 192.168.122.16:3260 --logout

```

REINICIAMOS EL EQUIPO Y AL INICIAR VERIFICAMOS

```
systemctl reboot

iscsiadm -m session -P3 | grep -i attach

```


















 







